---
title: CVPè®¤è¯å­¦ä¹ ç¬”è®°--(ä½•å°æˆ)025--éŸ³ä¹å’ŒéŸ³æ•ˆ
date: 2016-05-07 15:51
categories: cocos2d-js
tags: [cocos2d-js,cvp]
---
### æ¦‚å¿µ
æœ¬èŠ‚è¯¾å†…å®¹æ˜¯cocosä¸­éŸ³ä¹å’ŒéŸ³æ•ˆçš„ä½¿ç”¨ï¼Œæ¸¸æˆä¸­ç»å¸¸ä¼šæœ‰æ¸¸æˆéŸ³ä¹å’Œæ¸¸æˆéŸ³æ•ˆï¼Œå¹¶ä¸”å¥½çš„éŸ³ä¹éŸ³æ•ˆä¹Ÿæ˜¯ä¸€æ¬¾æ¸¸æˆçš„ä¸€ä¸ªå–ç‚¹ï¼Œåœ¨cocosä¸­ï¼Œå¯¹éŸ³ä¹å’ŒéŸ³æ•ˆåšäº†è‰¯å¥½çš„å°è£…ï¼Œä½¿ç”¨èµ·æ¥åªéœ€ä¸€ä¸¤å¥ä»£ç å°±èƒ½å®ç°ï¼Œæœ¬èŠ‚è¯¾ä»‹ç»äº†cocosä¸­éŸ³ä¹éŸ³æ•ˆçš„å¼€å§‹æš‚åœã€‚<!--more-->
### API
cocosä¸­çš„éŸ³ä¹éŸ³æ•ˆå¤„ç†è¢«å°è£…åœ¨äº†audioEngineä¸­ï¼Œé€šè¿‡ä½¿ç”¨audioEngineå°±å¯ä»¥è°ƒç”¨ç›¸åº”çš„éŸ³ä¹éŸ³æ•ˆAPIï¼ŒAPIæ–‡æ¡£åœ°å€æ˜¯ï¼šhttp://www.cocos.com/doc/jsdoc/symbols/cc.audioEngine.html
```javascript
// ç»“æŸéŸ³ä¹å’ŒéŸ³æ•ˆ
cc.audioEngine.end()
// éŸ³æ•ˆéŸ³é‡æœ€å¤§æ˜¯1.0ï¼Œæœ€å°æ˜¯0.0
cc.audioEngine.getEffectsVolume()
// éŸ³ä¹çš„æœ€å¤§éŸ³é‡æ˜¯1.0ï¼Œæœ€å°éŸ³é‡æ˜¯0.0  
cc.audioEngine.getMusicVolume()
// åˆ¤æ–­éŸ³ä¹æ˜¯å¦åœ¨æ’­æ”¾
cc.audioEngine.isMusicPlaying()
// æš‚åœæ’­æ”¾æ‰€æœ‰éŸ³æ•ˆ
cc.audioEngine.pauseAllEffects()
// æš‚åœæ’­æ”¾éŸ³æ•ˆ   
cc.audioEngine.pauseEffect()
// æš‚åœæ’­æ”¾éŸ³ä¹  
cc.audioEngine.pauseMusic()
// æ’­æ”¾éŸ³æ•ˆ  
cc.audioEngine.playEffect(url, loop)
// æ’­æ”¾éŸ³ä¹  
cc.audioEngine.playMusic(url, loop)
// é‡æ–°æ’­æ”¾æ‰€æœ‰éŸ³æ•ˆ 
cc.audioEngine.resumeAllEffects()
// é‡æ–°æ’­æ”¾éŸ³æ•ˆ  
cc.audioEngine.resumeEffect()
// é‡æ–°æ’­æ”¾éŸ³ä¹   
cc.audioEngine.resumeMusic()
// å›æ”¾æ’­æ”¾çš„éŸ³ä¹  
cc.audioEngine.rewindMusic()
// è®¾ç½®éŸ³æ•ˆçš„éŸ³é‡    
cc.audioEngine.setEffectsVolume(volume)
// è®¾ç½®éŸ³ä¹çš„éŸ³é‡
cc.audioEngine.setMusicVolume(volume)
// åœæ­¢æ’­æ”¾æ‰€æœ‰éŸ³æ•ˆ  
cc.audioEngine.stopAllEffects()
// åœæ­¢æ’­æ”¾éŸ³æ•ˆ
cc.audioEngine.stopEffect()
// åœæ­¢æ’­æ”¾éŸ³ä¹ 
cc.audioEngine.stopMusic(releaseData)
// ä»å†…éƒ¨ç¼“å†²åŒºé‡Šæ”¾é¢„åŠ è½½çš„éŸ³æ•ˆ   
cc.audioEngine.unloadEffect(url)
// æ ‡ç¤ºèƒŒæ™¯éŸ³ä¹æ˜¯å¦å¯ä»¥æ’­æ”¾   
cc.audioEngine.willPlayMusic()
```
### ä½œä¸š
æœ¬èŠ‚ä½œä¸šï¼š
æœ¬èŠ‚è¯¾ä½œä¸šè¦æ±‚å®ç°ç‚¹å‡»å±å¹•æ’­æ”¾éŸ³æ•ˆï¼Œæˆ‘è¿›è¡Œäº†æ‰©å±•ï¼Œç»¼åˆå‰é¢æ‰€å­¦ï¼Œåšäº†ä¸€ä¸ªæ‰“é£æœºçš„å°demoï¼Œç”±äºä¸æ˜¯ä¸€ä¸ªå®Œæ•´demoï¼Œæ‰€æœ‰æœ‰å¾ˆå¤šbugä¹Ÿæ²¡å»å¤„ç†ï¼Œå…¶ä¸­ä¹Ÿå®ç°äº†æ¸¸æˆä¸­çš„éŸ³ä¹éŸ³æ•ˆæ’­æ”¾ã€‚
ä½œä¸šä»£ç å®ç°å¦‚ä¸‹ï¼š
```javascript
var soundID=0;
var HelloWorldLayer = cc.Layer.extend({
    sprite:null,
    music:1,// 0åœæ­¢ï¼Œ1æ’­æ”¾
    state:0,//0é™æ­¢ï¼Œ1æ”»å‡»
    npcs:[],// æ•Œæœºæ•°ç»„
    bullets:[],// å­å¼¹æ•°ç»„
    game:0,// 0è¿›è¡Œä¸­,1lose
    score:null,// åˆ†æ•°æ§ä»¶
    ctor:function () {
        //////////////////////////////
        // 1. super init first
        this._super();
        var itemstartbg=new cc.MenuItemFont("ğŸš«",this.callback,this);
        itemstartbg.setTag(10);
        itemstartbg.setPositionY(cc.winSize.height-itemstartbg.height/2);
        itemstartbg.setPositionX(itemstartbg.width/2+20);
        var menu=new cc.Menu(itemstartbg);
        menu.setPosition(0,0);
        this.addChild(menu);
        
        var plane = new cc.Sprite("res/HelloWorld.png");
        plane.setPosition(cc.winSize.width/2,80);
        plane.setScale(0.5);
        this.addChild(plane);
        plane.setTag(1);
        
        this.schedule(this.createBullet,0.2);
        this.schedule(this.createNpc,0.5);
        this.schedule(this.collision);
        return true;
    },
    callback:function(obj)
    {// èƒŒæ™¯éŸ³ä¹æŒ‰é’®
        if(this.music==0){
            cc.log("playMusic");
            this.music=1;
            cc.audioEngine.playMusic("res/bg.mp3",true);//å¾ªç¯æ’­æ”¾
            obj.setString("ğŸš«");
        }else{
            cc.log("stopMusic");
            this.music=0;
            cc.audioEngine.stopMusic();//åœæ­¢éŸ³ä¹
            obj.setString("ğŸµ");
        }
    },
    // æ¸¸æˆé€»è¾‘åˆ¤æ–­
    collision:function(){
        if(this.game==1){
            cc.audioEngine.stopMusic();
            cc.director.runScene(new OverScene());
            return;
        }
        for(var j in this.npcs){
            var npc = this.npcs[j];
            //  åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ
            var plane = this.getChildByTag(1);
            if(cc.rectIntersectsRect(npc.getBoundingBox(),plane.getBoundingBox())){
                cc.log("over");
                this.game=1;
                return;
            }
            for(var i in this.bullets){
                var bullet = this.bullets[i];
                // åˆ¤æ–­æ˜¯å¦å‡»ä¸­æ•Œæœºï¼Œé€šè¿‡rectIntersectsRectè¿›è¡ŒçŸ©å½¢ç¢°æ’åˆ¤æ–­
                if(cc.rectIntersectsRect(bullet.getBoundingBox(),npc.getBoundingBox())){
                    cc.log("crash");
                    bullet.removeFromParent();
                    this.npcs.splice(j,1);
                    this.bullets.splice(i,1);
                    npc.runAction(
                        cc.sequence(
                            cc.scaleTo(0.2,0.5),
                            cc.spawn(
                                cc.rotateBy(0.5,720),
                                cc.scaleTo(0.5,0)
                            ),
                            cc.callFunc(function(npc){
                                npc.removeFromParent();
                            },npc)
                        )
                    );
                    return;
                }
            }
        }
    },
    createNpc:function(){
        var plane = new cc.Sprite("res/HelloWorld.png");
        var x = Math.round(Math.random()*cc.winSize.width);
        plane.setPosition(x,cc.winSize.height+plane.height/2);
        plane.setScale(0.2);
        this.addChild(plane);
        var time = Math.round(Math.sqrt(Math.pow(x-x,2)+Math.pow(0-plane.height/2-cc.winSize.height+plane.height/2,2)))/100;
        plane.runAction(
            cc.sequence(
                cc.moveTo(time,x,0-plane.height/2),
                cc.callFunc(function(plane){
                    plane.removeFromParent();
                },plane)
            )
        );
        this.npcs.push(plane);
    },
    createBullet:function(){
        if(this.state==1){
            var sp = new cc.Sprite("res/logo.png");
            cc.audioEngine.playEffect("res/click.wav");
            var x = this.getChildByTag(1).getPositionX();
            var y = this.getChildByTag(1).getPositionY()+this.getChildByTag(1).height/2;
            sp.setPosition(x,y);
            this.addChild(sp);
            sp.setScale(0.3);
            var time = Math.round(Math.sqrt(Math.pow(x-x,2)+Math.pow(cc.winSize.height+sp.height/2-y,2)))/100;
            sp.runAction(
                cc.spawn(
                    cc.rotateBy(time,720).repeatForever(),
                    cc.sequence(
                        cc.moveTo(time,x,cc.winSize.height+sp.height/2),
                        cc.callFunc(function(sp){
                            sp.removeFromParent();
                        },sp)
                    )
                )
            );
            this.bullets.push(sp);
        }
    },
    onEnter:function(){
        this._super();
        cc.eventManager.addListener({
            event:cc.EventListener.TOUCH_ONE_BY_ONE,
            swallowTouches:true,
            onTouchBegan:this.touchbegan,
            onTouchMoved:this.touchMoved,
            onTouchEnded:this.touchEnded
        },this);
        cc.audioEngine.playMusic("res/bg.mp3",true);
        return true;
    },
    touchbegan:function(touch,event){
        event.getCurrentTarget().state=1;
        var x = touch.getLocationX();
        var y = touch.getLocationY();
        var plane = event.getCurrentTarget().getChildByTag(1);
        var time = Math.round(Math.sqrt(Math.pow(x-plane.getPositionX(),2)+Math.pow(y-plane.getPositionY(),2)))/1000;
        plane.stopAllActions(); 
        plane.runAction(cc.moveTo(time,cc.p(x,y)));
        return true;
    },
    touchMoved:function(touch,event){
        var x = touch.getLocationX();
        var y = touch.getLocationY();
        var plane = event.getCurrentTarget().getChildByTag(1);
        plane.stopAllActions(); 
        plane.setPosition(x,y);
        return true;
    },
    touchEnded:function(touch,event){
        event.getCurrentTarget().state=0;
        return true;
    }
});

var OverScene = cc.Scene.extend({
    onEnter:function () {
        this._super();
        var overTxt = new cc.LabelTTF("Game Over","",100);
        overTxt.setPosition(cc.winSize.width/2,cc.winSize.height/2);
        this.addChild(overTxt);
        overTxt.runAction(
            cc.sequence(cc.scaleTo(0.2,1.2),cc.scaleTo(0.2,0.9),cc.scaleTo(0.2,1))    
        );
        var backMenu = new cc.MenuItemFont("å†æ¥ä¸€æ¬¡",function(){
            cc.director.runScene(new HelloWorldScene());
        },this);
        backMenu.setPosition(overTxt.getPositionX(),overTxt.getPositionY()-50-backMenu.height/2);
        var menu = new cc.Menu(backMenu);
        menu.setPosition(0,0);
        this.addChild(menu);
    }
});

var HelloWorldScene = cc.Scene.extend({
    onEnter:function () {
        this._super();
        var layer = new HelloWorldLayer();
        this.addChild(layer);
    }
});
```

### æœ€ç»ˆæ•ˆæœ
http://www.cocoscvp.com/usercode/2016_05_03/066a65bf1bf65dcd589d18a33ad67990822843c1/