<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.hjcenry.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":false,"nav":{"changyan":{"text":"加载评论中","order":-1}},"activeClass":"changyan"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。  前言上文介绍了我们的SLG手游的服务器架构设计以及网络通信部分，本文介绍数据管理部分，在数据存储方面，我选择了Mysql、Memcache和Redis，利用这三种数据库各自的优势，各自发挥所长，在项目中有着不同的应用。">
<meta property="og:type" content="article">
<meta property="og:title" content="SLG手游Java服务器的设计与开发——数据管理">
<meta property="og:url" content="http://www.hjcenry.com/2016/09/04/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="Henry Blog">
<meta property="og:description" content="文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。  前言上文介绍了我们的SLG手游的服务器架构设计以及网络通信部分，本文介绍数据管理部分，在数据存储方面，我选择了Mysql、Memcache和Redis，利用这三种数据库各自的优势，各自发挥所长，在项目中有着不同的应用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/%E6%B8%B8%E6%88%8F%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/Mysql%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/Redis%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B1.png">
<meta property="og:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B2.png">
<meta property="og:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B3.png">
<meta property="og:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B4.png">
<meta property="article:published_time" content="2016-09-04T02:13:00.000Z">
<meta property="article:modified_time" content="2020-09-29T03:25:11.723Z">
<meta property="article:author" content="Henry He">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="游戏服务器">
<meta property="article:tag" content="SLG">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://7xnnwn.com1.z0.glb.clouddn.com/%E6%B8%B8%E6%88%8F%E6%95%B0%E6%8D%AE.png">

<link rel="canonical" href="http://www.hjcenry.com/2016/09/04/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SLG手游Java服务器的设计与开发——数据管理 | Henry Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
<link rel="alternate" href="/atom.xml" title="Henry Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Henry Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Javaer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/hjcenry" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.hjcenry.com/2016/09/04/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Henry He">
      <meta itemprop="description" content="我们不生产代码，我们只是API的搬运工">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Henry Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SLG手游Java服务器的设计与开发——数据管理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-04 10:13:00" itemprop="dateCreated datePublished" datetime="2016-09-04T10:13:00+08:00">2016-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-29 11:25:11" itemprop="dateModified" datetime="2020-09-29T11:25:11+08:00">2020-09-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
          <!--
            <span id="/2016/09/04/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/" class="post-meta-item leancloud_visitors" data-flag-title="SLG手游Java服务器的设计与开发——数据管理" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          -->
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <!--
    
      <a title="changyan" href="/2016/09/04/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/#SOHUCS" itemprop="discussionUrl">
        <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2016/09/04/SLG手游Java服务器的设计与开发——数据管理/" itemprop="commentCount"></span>
      </a>
    
    -->
    <a title="changyan" href="/2016/09/04/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86/#SOHUCS" itemprop="discussionUrl">
        <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2016/09/04/SLG手游Java服务器的设计与开发——数据管理/" itemprop="commentCount"></span>
      </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li><code>文章版权归腾讯GAD所有，禁止匿名转载；禁止商业使用；禁止个人使用。</code></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上文介绍了我们的SLG手游的服务器架构设计以及网络通信部分，本文介绍数据管理部分，在数据存储方面，我选择了Mysql、Memcache和Redis，利用这三种数据库各自的优势，各自发挥所长，在项目中有着不同的应用。</p>
<a id="more"></a>
<h2 id="游戏数据分析"><a href="#游戏数据分析" class="headerlink" title="游戏数据分析"></a>游戏数据分析</h2><p>前文已经对游戏数据做了大概的分析，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E6%B8%B8%E6%88%8F%E6%95%B0%E6%8D%AE.png" alt="游戏数据"><br>这是我个人对游戏中的数据进行的一种划分。其中，游戏数据直接使用代码将表文件中的数据加载到内存，然后从内存中读取数据即可。玩家数据则分为了热数据和冷数据两部分分别进行存储，最大程度利用Mysql和Redis各自的优势。</p>
<h2 id="游戏静态数据"><a href="#游戏静态数据" class="headerlink" title="游戏静态数据"></a>游戏静态数据</h2><p>在我们的这款游戏中，我们的静态数据配置在CSV表文件中，在服务器启动时，我读取所有的表文件，然后取出数据放到Map中，一般以一个标志性列（如ID）为key，一个JavaBean作为value放入到Map中。<br>读取CSV表文件步骤如下：<br>1.读取CSV文件<br>2.按一定格式对文件内容进行解析<br>3.将内容封装到JavaBean<br>4.存放数据到Map中<br>读取完了之后，在代码中如果需要，只需通过key在Map中来读取即可。<br>在项目中，我将整个过程进行了封装，封装成了dataConfig.xml文件、*.csv文件、JavaBean、CsvLoader.java、CsvParser.java和TempletService.java，添加一个CSV文件的步骤如下：<br>1.在dataConfig.xml中添加csv文件路径<br>2.创建一个和CSV文件中结构一模一样的JavaBean<br>3.服务器启动时调用CsvLoader的load()方法来加载所有的CSV文件<br>4.调用TempletService.listAll()方法，并传入Javabean的simpleName来加载CSV文件内容到List中<br>5.将List中的内容按一定结构存储（我一般都存为Map结构）</p>
<h3 id="dataConfig-xml"><a href="#dataConfig-xml" class="headerlink" title="dataConfig.xml"></a>dataConfig.xml</h3><p>dataConfig.xml中存储所有CSV表的路径，在CsvLoader.java中直接对这个xml表中的路径下的CSV文件进行读取加载。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">&quot;Card.csv&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">&quot;Equip.csv&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--省略更多CSV表--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="CSV文件"><a href="#CSV文件" class="headerlink" title="CSV文件"></a>CSV文件</h3><p>CSV文件中存储具体的游戏数据，这个数据表一般是由数值策划来进行配置。CSV表的本质就是按逗号进行分割的数据，如下是卡牌表的前两行数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">卡牌ID,卡牌名称,英雄动画名称,卡牌兵种name,卡牌兵种类型,卡牌兵种美术资源ID,品质编号,所属势力,英雄等级,英雄升星等级,技能id,统,勇,智,初始兵力,初始攻击力,兵力,攻击力,克制系数,被克制系数,移动速度,爆击率,爆击倍数,普攻伤害加深,普攻伤害减免,技能伤害加深,技能伤害减免,普攻伤害点数,普攻免伤点数,技能伤害点数,技能减伤点数,KPI,技能名称,技能描述：目标 目标个数（范围）效果数值buff描述,英雄定位</span><br><span class="line">CardId,CardName,CardFlashName,CardSoldName,CardSoldID,CardSoldFlashID,RMBID,CountryID,CardLv,CardStar,SkillID,Tong,Yong,Zhi,HpStar,AttackStar,Hp,Attack,Kezhi,Beikezhi,Speed,Crit,Double,AttackAddbaifen,Attackreducebaifen,SkillAddbaifen,Skillreducebaifen,AttackNum,AttackreduceNum,SkillAddNum,SkillreduceNum,KPI,SkillName,SkillDes,HeroLocal</span><br><span class="line">200001,吕布,lvbu,骑兵,2,4,8,4,1,1,200001,105,110,90,344,70,2.22,2.26,0.17,0.43,385,0.16,1.44,0.176,0.144,0.176,0.144,0,0,0,0,1000,猛将无双,对敌方所有目标造成 1倍伤害并且全体晕眩3秒</span><br><span class="line">200002,赵云,zhaoyun,步兵,3,1,8,2,1,1,200002,103,106,100,381,62,2.464,2.008,0.31,0.29,300,0.16,1.44,0.128,0.208,0.128,0.208,0,0,0,0,1000,枪出如龙,对敌方目标造成3次0.5倍伤害并提升自身50%爆击率持续4秒</span><br></pre></td></tr></table></figure>
<h3 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h3><p>添加了CSV文件之后，我们需要创建一个和CSV表结构一模一样的JavaBean，如下是卡牌表对应的JavaBean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.template;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Card</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardId;</span><br><span class="line">    <span class="keyword">private</span> String CardName;</span><br><span class="line">    <span class="keyword">private</span> String CardFlashName;</span><br><span class="line">    <span class="keyword">private</span> String CardSoldName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardSoldID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardSoldFlashID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> RMBID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CountryID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardLv;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> CardStar;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> SkillID;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Tong;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Yong;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Zhi;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> HpStar;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> AttackStar;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Hp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Attack;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Kezhi;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Beikezhi;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> Speed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Crit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Double;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> AttackAddbaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Attackreducebaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> SkillAddbaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> Skillreducebaifen;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> AttackreduceNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> AttackNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> SkillAddNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> SkillreduceNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> KPI;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CsvDataLoader-java"><a href="#CsvDataLoader-java" class="headerlink" title="CsvDataLoader.java"></a>CsvDataLoader.java</h3><p>CsvDataLoader封装了对CSV数据的载入，包括使用SAXReader对dataConfig.xml文件的读取，以及对其中的CSV文件的内容的读取，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.csv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.sql.Timestamp;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Element;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvDataLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(CsvDataLoader.class);</span><br><span class="line">    <span class="keyword">private</span> String packageName;</span><br><span class="line">    <span class="keyword">private</span> String config; <span class="comment">// 每一行就是一个配置文件名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> ActivityMaxValue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CsvDataLoader inst;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvDataLoader</span><span class="params">(String packageName, String config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CsvDataLoader <span class="title">getInstance</span><span class="params">(String packageName, String config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inst == <span class="keyword">null</span>) &#123;</span><br><span class="line">            inst = <span class="keyword">new</span> CsvDataLoader(packageName, config);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inst;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用load方法加载所有的配置文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">        InputStream resourceStream = <span class="keyword">this</span>.getClass().getResourceAsStream(</span><br><span class="line">                <span class="keyword">this</span>.config);</span><br><span class="line">        InputStreamReader resourceStreamReader = <span class="keyword">new</span> InputStreamReader(</span><br><span class="line">                resourceStream);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document doc = reader.read(resourceStreamReader);</span><br><span class="line">            List&lt;?&gt; nodes = doc.selectNodes(<span class="string">&quot;/config/file&quot;</span>);</span><br><span class="line">            Map&lt;String, List&lt;?&gt;&gt; dataMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;?&gt;&gt;();</span><br><span class="line">            List&lt;String&gt; files = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Object n : nodes) &#123;</span><br><span class="line">                Element t = (Element) n;</span><br><span class="line">                String f = t.attributeValue(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                List&lt;?&gt; dataList = <span class="keyword">this</span>.loadFile(f, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">for</span> (Object o : dataList) &#123;</span><br><span class="line">                    TempletService.getInstance().registerObject(o, dataMap);</span><br><span class="line">                &#125;</span><br><span class="line">                files.add(f);</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(<span class="string">&quot;读取配置完毕，准备afterLoad&quot;</span>);</span><br><span class="line">            TempletService.templetMap = dataMap;</span><br><span class="line">            TempletService.getInstance().afterLoad();</span><br><span class="line">            logger.info(<span class="string">&quot;afterLoad 完毕&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (resourceStreamReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resourceStreamReader.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resourceStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resourceStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; loadFile(String file, <span class="keyword">boolean</span> exitWhenFail) &#123;<span class="comment">// 读文件</span></span><br><span class="line">        InputStream resourceAsStream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String clzName = file.replaceAll(<span class="string">&quot;.csv&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            file = GameInit.confFileBasePath + file;</span><br><span class="line">            logger.info(<span class="string">&quot;load file: &#123;&#125;&quot;</span>, file);</span><br><span class="line">            <span class="comment">// resourceAsStream = this.getClass().getResourceAsStream(file);</span></span><br><span class="line">            resourceAsStream = <span class="keyword">this</span>.getClass().getClassLoader()</span><br><span class="line">                    .getResource(file).openStream();</span><br><span class="line">            <span class="keyword">if</span> (resourceAsStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;文件不存在:&quot;</span> + file);</span><br><span class="line">                <span class="keyword">if</span> (exitWhenFail) &#123;</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> loadFromStream(resourceAsStream, clzName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;载入文件出错：&quot;</span> + file);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (resourceAsStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resourceAsStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Collections.EMPTY_LIST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;?&gt; loadFromStream(InputStream resourceAsStream, String clzName)</span><br><span class="line">            <span class="keyword">throws</span> DocumentException, InstantiationException,</span><br><span class="line">            IllegalAccessException, IOException &#123;<span class="comment">// 读csv文件</span></span><br><span class="line">        CsvParser csvParser = <span class="keyword">new</span> CsvParser(resourceAsStream);</span><br><span class="line">        List&lt;String&gt; nodes = csvParser.getListWithNoHeader();</span><br><span class="line">        <span class="comment">// get clazz</span></span><br><span class="line">        String className = <span class="keyword">this</span>.packageName + clzName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; classObject = Class.forName(className);</span><br><span class="line">            <span class="keyword">if</span> (classObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;未找到类&quot;</span> + className);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Get all the declared fields</span></span><br><span class="line">            Field[] fields = classObject.getDeclaredFields();</span><br><span class="line">            LinkedList&lt;Field&gt; fieldList = <span class="keyword">new</span> LinkedList&lt;Field&gt;();</span><br><span class="line">            <span class="keyword">int</span> length = fields.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = -<span class="number">1</span>; ++i &lt; length;) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> isStaticField = Modifier.isStatic(fields[i]</span><br><span class="line">                        .getModifiers());</span><br><span class="line">                <span class="keyword">if</span> (isStaticField)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">boolean</span> isTransientField = Modifier.isTransient(fields[i]</span><br><span class="line">                        .getModifiers());</span><br><span class="line">                <span class="keyword">if</span> (isTransientField)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                fieldList.add(fields[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Get all the declared fields of supper class</span></span><br><span class="line">            Class&lt;?&gt; tmp = classObject;</span><br><span class="line">            <span class="keyword">while</span> ((tmp = tmp.getSuperclass()) != Object.class) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;the extends class is&quot;</span> + tmp.getName());</span><br><span class="line">                fields = tmp.getDeclaredFields();</span><br><span class="line">                length = fields.length;</span><br><span class="line">                <span class="keyword">if</span> (length == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = -<span class="number">1</span>; ++i &lt; length;) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> isStaticField = Modifier.isStatic(fields[i]</span><br><span class="line">                            .getModifiers());</span><br><span class="line">                    <span class="keyword">if</span> (isStaticField)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">boolean</span> isTransientField = Modifier.isTransient(fields[i]</span><br><span class="line">                            .getModifiers());</span><br><span class="line">                    <span class="keyword">if</span> (isTransientField)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    fieldList.add(fields[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The truly need to return object</span></span><br><span class="line">            List&lt;Object&gt; instances = <span class="keyword">new</span> ArrayList&lt;Object&gt;(nodes.size());</span><br><span class="line">            Object instance = <span class="keyword">null</span>;</span><br><span class="line">            String fieldName = <span class="keyword">null</span>;</span><br><span class="line">            String fieldValue = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (String node : nodes) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = classObject.newInstance();</span><br><span class="line">                    <span class="keyword">boolean</span> ok = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="comment">// Element row = (Element) node;</span></span><br><span class="line">                    String[] values = node.split(<span class="string">&quot;,&quot;</span>);<span class="comment">// csv文件以英文逗号分割值</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fieldList.size(); i++) &#123;</span><br><span class="line">                        Field field = fieldList.get(i);</span><br><span class="line">                        fieldName = field.getName();</span><br><span class="line">                        fieldValue = values[i];</span><br><span class="line">                        <span class="keyword">if</span> (fieldValue == <span class="keyword">null</span>)</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.setField(instance, field, fieldValue);</span><br><span class="line">                            ok = <span class="keyword">true</span>;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            logger.error(<span class="string">&quot;类名称是&quot;</span> + className + <span class="string">&quot;的属性&quot;</span> + fieldName</span><br><span class="line">                                    + <span class="string">&quot;没有被成功赋予静态数据&quot;</span>);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                        instances.add(instance);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instances;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e1) &#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">            logger.error(<span class="string">&quot;未找到类&quot;</span> + className);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Title</span>: setUnknowField</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ob</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> f</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> v</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, Field f, String v)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException </span>&#123;</span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (f.getType() == <span class="keyword">int</span>.class) &#123;</span><br><span class="line">            f.setInt(obj, Integer.parseInt(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">short</span>.class) &#123;</span><br><span class="line">            f.setShort(obj, Short.parseShort(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">byte</span>.class) &#123;</span><br><span class="line">            f.setByte(obj, Byte.parseByte(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">long</span>.class) &#123;</span><br><span class="line">            f.setLong(obj, Long.parseLong(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">double</span>.class) &#123;</span><br><span class="line">            f.setDouble(obj, Double.parseDouble(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == <span class="keyword">float</span>.class) &#123;</span><br><span class="line">            f.setFloat(obj, Float.parseFloat(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getType() == Timestamp.class) &#123;</span><br><span class="line">            f.set(obj, Timestamp.valueOf(v));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            f.set(obj, f.getType().cast(v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Test Code</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CsvDataLoader dl = <span class="keyword">new</span> CsvDataLoader(<span class="string">&quot;com.kidbear._36.template.&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/dataConfig.xml&quot;</span>);</span><br><span class="line">        dl.load();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CsvParser"><a href="#CsvParser" class="headerlink" title="CsvParser"></a>CsvParser</h3><p>CsvDataLoader中用到的CsvParser是具体对CSV文件按逗号分割的格式的解析的类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.csv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStreamWriter;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//JAVA 操作 excel 中的 .csv文件格式</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvParser</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BufferedReader bufferedreader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvParser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CsvParser</span><span class="params">(InputStream inStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(inStream, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        bufferedreader = <span class="keyword">new</span> BufferedReader(isr);</span><br><span class="line">        String stemp;</span><br><span class="line">        <span class="keyword">while</span> ((stemp = bufferedreader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            list.add(stemp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">getList</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">getListWithNoHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list.subList(<span class="number">2</span>, list.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到csv文件的行数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRowNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到csv文件的列数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!list.toString().equals(<span class="string">&quot;[]&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (list.get(<span class="number">0</span>).toString().contains(<span class="string">&quot;,&quot;</span>)) &#123; <span class="comment">// csv文件中，每列之间的是用&#x27;,&#x27;来分隔的</span></span><br><span class="line">                <span class="keyword">return</span> list.get(<span class="number">0</span>).toString().split(<span class="string">&quot;,&quot;</span>).length;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (list.get(<span class="number">0</span>).toString().trim().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得指定行的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRow</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.list.size() != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (String) list.get(index);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得指定列的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCol</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.getColNum() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer scol = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String temp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> colnum = <span class="keyword">this</span>.getColNum();</span><br><span class="line">        <span class="keyword">if</span> (colnum &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator it = list.iterator(); it.hasNext();) &#123;</span><br><span class="line">                temp = it.next().toString();</span><br><span class="line">                scol = scol.append(temp.split(<span class="string">&quot;,&quot;</span>)[index] + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator it = list.iterator(); it.hasNext();) &#123;</span><br><span class="line">                temp = it.next().toString();</span><br><span class="line">                scol = scol.append(temp + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String str = <span class="keyword">new</span> String(scol.toString());</span><br><span class="line">        str = str.substring(<span class="number">0</span>, str.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得指定行，指定列的值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">int</span> row, <span class="keyword">int</span> col)</span> </span>&#123;</span><br><span class="line">        String temp = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> colnum = <span class="keyword">this</span>.getColNum();</span><br><span class="line">        <span class="keyword">if</span> (colnum &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            temp = list.get(row).toString().split(<span class="string">&quot;,&quot;</span>)[col];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colnum == <span class="number">1</span>) &#123;</span><br><span class="line">            temp = list.get(row).toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CsvClose</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bufferedreader.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">readCvs</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        CsvParser cu = <span class="keyword">new</span> CsvParser(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(filename)));</span><br><span class="line">        List list = cu.getList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createCsv</span><span class="params">(String biao, List list, String path)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List tt = list;</span><br><span class="line">        String data = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        SimpleDateFormat dataFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line">        Date today = <span class="keyword">new</span> Date();</span><br><span class="line">        String dateToday = dataFormat.format(today);</span><br><span class="line">        File file = <span class="keyword">new</span> File(path + <span class="string">&quot;resource/expert/&quot;</span> + dateToday</span><br><span class="line">                + <span class="string">&quot;importerrorinfo.csv&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists())</span><br><span class="line">            file.createNewFile();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            file.delete();</span><br><span class="line">        String str[];</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        sb.append(biao);</span><br><span class="line">        FileOutputStream writerStream = <span class="keyword">new</span> FileOutputStream(file, <span class="keyword">true</span>);</span><br><span class="line">        BufferedWriter output = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(</span><br><span class="line">                writerStream, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (Iterator itt = tt.iterator(); itt.hasNext();) &#123;</span><br><span class="line">            String fileStr = itt.next().toString();</span><br><span class="line">            <span class="comment">// str = fileStr.split(&quot;,&quot;);</span></span><br><span class="line">            <span class="comment">// for (int i = 0; i &lt;= str.length - 1; i++) &#123; // 拆分成数组 用于插入数据库中</span></span><br><span class="line">            <span class="comment">// System.out.print(&quot;str[&quot; + i + &quot;]=&quot; + str[i] + &quot; &quot;);</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">            <span class="comment">// System.out.println(&quot;&quot;);</span></span><br><span class="line">            sb.append(fileStr + <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        output.write(sb.toString());</span><br><span class="line">        output.flush();</span><br><span class="line">        output.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TempletService-java"><a href="#TempletService-java" class="headerlink" title="TempletService.java"></a>TempletService.java</h3><p>服务器启动时，调用CsvDataLoader的load()方法，以完成对CSV文件的加载，之后就需要使用TempletService的listAll方法来讲数据加载到List中，TempletService根据JavaBean的simpleName来对数据进行加载，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.csv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加一个数据表需要做以下几步 </span></span><br><span class="line"><span class="comment"> * 1.在包com.kidbear._36.template下创建对应的模板类，类名与数据文件一致 </span></span><br><span class="line"><span class="comment"> * 2.在src/main/resources/csv/中添加模板数据文件</span></span><br><span class="line"><span class="comment"> * 3.在src/main/resources/dataConfig.xml加入刚才的模板数据文件</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 何金成</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TempletService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(TempletService.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TempletService templetService = <span class="keyword">new</span> TempletService();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key:实体名 value:该实体下的所有模板数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, List&lt;?&gt;&gt; templetMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TempletService</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TempletService <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> templetService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取该实体类下所有模板数据</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List <span class="title">listAll</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> templetMap.get(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Title</span>: registerObject </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 注册对象到对应类的List中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerObject</span><span class="params">(Object o, Map&lt;String, List&lt;?&gt;&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        add(o.getClass().getSimpleName(), o, dataMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String key, Object data, Map&lt;String, List&lt;?&gt;&gt; dataMap)</span> </span>&#123;</span><br><span class="line">        List list = dataMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">            list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            dataMap.put(key, list);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加载后处理</span></span><br><span class="line">        <span class="comment">// List tests = TempletService.listAll(Test.class.getSimpleName());</span></span><br><span class="line">        <span class="comment">// for (Object object : tests) &#123;</span></span><br><span class="line">        <span class="comment">// Test test = (Test)object;</span></span><br><span class="line">        <span class="comment">// System.out.print(test.getEquipLv());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv1());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv2());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv3());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv4());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv5());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv6());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv7());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv8());</span></span><br><span class="line">        <span class="comment">// System.out.print(&quot;,&quot;+test.getLv9());</span></span><br><span class="line">        <span class="comment">// System.out.println(&quot;,&quot;+test.getLv10());</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadCanShu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 加载全局参数xml配置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用静态数据"><a href="#使用静态数据" class="headerlink" title="使用静态数据"></a>使用静态数据</h3><p>在完成了添加和加载等一系列操作之后，就可以在代码中调用CSV表中加载进来的数据了，例如上文提到的卡牌数据表，加载代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 卡牌数据表</span></span><br><span class="line">List&lt;Card&gt; cardList = TempletService</span><br><span class="line">                .listAll(Card.class.getSimpleName());</span><br><span class="line">Map&lt;Integer, Card&gt; cardMap = <span class="keyword">new</span> HashMap&lt;Integer, Card&gt;();</span><br><span class="line"><span class="keyword">for</span> (Card card : cardList) &#123;</span><br><span class="line">    cardMap.put(card.getCardId(), card);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.cardMap = cardMap;</span><br></pre></td></tr></table></figure>
<p>使用时只需要根据卡牌的Id，就可以取到这张卡牌的所有数据。</p>
<h2 id="Mysql存储数据"><a href="#Mysql存储数据" class="headerlink" title="Mysql存储数据"></a>Mysql存储数据</h2><p>我们使用Mysql作为冷数据的存储数据库，并使用Druid和Hibernate来创建数据库的连接以及增删改查的操作。在游戏数据中，我对游戏中的冷数据做了一个总结，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Mysql%E6%95%B0%E6%8D%AE.png" alt="Mysql数据"><br>完成要存储的游戏数据的分析之后，我们就可以进行具体建模建表的工作，完成对数据的设计。由于在游戏服务器的数据存储中，数据库基本上只是一个游戏数据临时存放的地方，所以游戏数据中的关联性并不是特别强，所以不需要严密的数据库设计，只需简单的将玩家所有的数据按照一个userid进行关联即可，在使用Hibernate的时候，我们使用了Hibernate4，使用了它注解JavaBean自动建表的功能，我们只需将需要存储的Model写成JavaBean，并写上注解，在启动时，Hibernate扫描到JavaBean会自动为我们创建或更新表。</p>
<h3 id="Druid数据库连接池"><a href="#Druid数据库连接池" class="headerlink" title="Druid数据库连接池"></a>Druid数据库连接池</h3><p>游戏服务器运行中经常是多个玩家同时在线的，可想而知，如果同时进行某一项涉及数据库的操作时，也会并发请求数据库，多个数据库请求就需要我们对多个数据库连接进行有效的管理，当然，我们可以自己写一个数据库卡连接池来进行数据库管理，但好在以后前辈为我们做足了工作，有很多成型的开源数据库连接池可供我们选择，常见的有c3p0、dbcp、proxool和driud等，这里我们使用阿里巴巴公司的开源产品Druid，这是我个人认为最好用的数据库连接池，它不仅提供了数据库连接池应有的功能，更是提供了良好的数据库监控性能，这是我们作为开发人员在遇到性能瓶颈时最需要的东西，感兴趣的朋友可以参考下官方github，根据官方wiki配置一个Druid的数据监控系统，通过系统可以查看数据库的各种性能指标。<br>Druid在github中的地址是：<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid">https://github.com/alibaba/druid</a><br>在项目中使用druid，首先我们需要导入druid所需jar包以及Mysql的驱动jar包，由于我们是maven项目，我们就直接添加pom依赖，代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Mysql驱动--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--数据库连接池--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在spring的xml中对druid进行配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.user&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.maxActive&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.initialSize&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置获取连接等待超时的时间 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxWait&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.maxWait&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.timeBetweenEvictionRunsMillis&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.minEvictableIdleTimeMillis&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--过滤 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filters&quot;</span> <span class="attr">value</span>=<span class="string">&quot;config,wall,mergeStat&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--密码加密 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- property name=&quot;connectionProperties&quot; value=&quot;config.decrypt=true&quot; / --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--合并多个数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useGloalDataSourceStat&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;proxyFilters&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;log-filter&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;stat-filter&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;log-filter&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.filter.logging.Log4jFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;statementLogErrorEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;statementLogEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;stat-filter&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.filter.stat.StatFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;slowSqlMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;logSlowSql&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后需要在web.xml中再对druid的filter进行配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>DruidWebStatFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.alibaba.druid.support.http.WebStatFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>exclusions<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>weburi.json,.html,.js,.gif,.jpg,.png,.css,.ico,/fonts/*,/datas/*,images/*<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>sessionStatMaxCount<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>principalSessionName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>FRONT_USER<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>DruidWebStatFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.alibaba.druid.support.http.StatViewServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/druid/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>至此为止，Druid的配置就算是完成，启动工程之后我们还能通过/druid路径来访问Druid提供的监控系统，更多关于Druid的使用可以参照github中的wiki介绍，了解更多Druid配置及参数设置。</p>
<h3 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a>Hibernate</h3><p>使用Hibernate作为Mysql数据库的ORM框架，主要是因为其良好的封装，首先我个人认为Hibernate的性能是不足与和原生JDBC以及MyBatis这样的框架所匹敌的，封装的更好却带来了更多的性能损失，但我使用他也是看中他良好的封装性，因为我对性能的需求还没有达到很高的级别；其次，Hibernate很难写出复杂的SQL查询，而MyBatis却可以写出一些复杂的SQL，但在我的设计中，我不需要太复杂的查询，基本上我所有的SQL语句的where条件都是”where userid=?”，因此在性能需求上以及易用的对比上，我选择了Hibernate。<br>我使用的版本你是Hibernate4，因为Hibernate4提供了注解自动创建表的功能，Hibernate集成在spring的配置的xml代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义事务管理 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.hibernate4.HibernateTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionFactory&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 事务执行方式 REQUIRED：指定当前方法必需在事务环境中运行， 如果当前有事务环境就加入当前正在执行的事务环境， 如果当前没有事务，就新建一个事务。 </span></span><br><span class="line"><span class="comment">            这是默认值。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;create*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;save*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;add*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;update*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;remove*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;del*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;import*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定当前方法以非事务方式执行操作，如果当前存在事务，就把当前事务挂起，等我以非事务的状态运行完，再继续原来的事务。 查询定义即可 </span></span><br><span class="line"><span class="comment">            read-only=&quot;true&quot; 表示只读 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;NOT_SUPPORTED&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- hibernate SessionFactory --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sessionFactory&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.hibernate4.LocalSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- hibernate的相关属性配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hibernateProperties&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 设置数据库方言 --&gt;</span></span><br><span class="line">            hibernate.dialect=org.hibernate.dialect.MySQLDialect</span><br><span class="line">            <span class="comment">&lt;!-- 设置自动创建|更新|验证数据库表结构 --&gt;</span></span><br><span class="line">            hibernate.hbm2ddl.auto=update</span><br><span class="line">            <span class="comment">&lt;!-- 是否在控制台显示sql --&gt;</span></span><br><span class="line">            hibernate.show_sql=false</span><br><span class="line">            <span class="comment">&lt;!-- 是否格式化sql，优化显示 --&gt;</span></span><br><span class="line">            hibernate.format_sql=false</span><br><span class="line">            <span class="comment">&lt;!-- 是否开启二级缓存 --&gt;</span></span><br><span class="line">            hibernate.cache.use_second_level_cache=false</span><br><span class="line">            <span class="comment">&lt;!-- 是否开启查询缓存 --&gt;</span></span><br><span class="line">            hibernate.cache.use_query_cache=false</span><br><span class="line">            <span class="comment">&lt;!-- 数据库批量查询最大数 --&gt;</span></span><br><span class="line">            hibernate.jdbc.fetch_size=50</span><br><span class="line">            <span class="comment">&lt;!-- 数据库批量更新、添加、删除操作最大数 --&gt;</span></span><br><span class="line">            hibernate.jdbc.batch_size=50</span><br><span class="line">            <span class="comment">&lt;!-- 是否自动提交事务 --&gt;</span></span><br><span class="line">            hibernate.connection.autocommit=true</span><br><span class="line">            <span class="comment">&lt;!-- 指定hibernate在何时释放JDBC连接 --&gt;</span></span><br><span class="line">            hibernate.connection.release_mode=auto</span><br><span class="line">            <span class="comment">&lt;!-- 创建session方式 hibernate4.x 的方式 --&gt;</span></span><br><span class="line">            hibernate.current_session_context_class=thread</span><br><span class="line">            <span class="comment">&lt;!-- javax.persistence.validation.mode默认情况下是auto的，就是说如果不设置的话它是会自动去你的classpath下面找一个bean-validation**包 </span></span><br><span class="line"><span class="comment">                所以把它设置为none即可 --&gt;</span></span><br><span class="line">            javax.persistence.validation.mode=none</span><br><span class="line">        <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 自动扫描实体对象 tdxy.bean的包结构中存放实体类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;packagesToScan&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.kidbear._36&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置完了之后，我们需要对我们需要进行存储的数据进行注解，如君主信息的Model如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.manager.junzhu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Column;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.cache.MCSupport;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;JunZhu&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JunZhu</span> <span class="keyword">implements</span> <span class="title">MCSupport</span> </span>&#123;</span><br><span class="line">    <span class="comment">// id，用户id，用户名字，用户所属国家，用户头像（用数字表示），用户等级，用户vip等级，用户军令数，用户金宝，用户银宝，用户粮食，用户精铁，用户木材，</span></span><br><span class="line">    <span class="comment">// 用户兵数量，用户军工数，用户将魂数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5385044598250102957L</span>;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> id;<span class="comment">// —用户id</span></span><br><span class="line">    <span class="keyword">public</span> String name;<span class="comment">// — 用户名</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> headImg;<span class="comment">// —用户头像</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> role;<span class="comment">// —用户角色</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> country;<span class="comment">// —用户所属国家 1表示蜀国 2表示魏国 3表示吴国</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> exp;<span class="comment">// —用户等级 —君主等级</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> level;<span class="comment">// —用户等级 —君主等级</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> vip;<span class="comment">// —用户vip等级</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> vipExp;<span class="comment">// —用户vip经验</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> junling;<span class="comment">// —用户军令数</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> coin;<span class="comment">// —用户金币</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> yuanbao;<span class="comment">// —用户元宝</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> food;<span class="comment">// —用户粮食</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> iron;<span class="comment">// —用户精铁</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> wood;<span class="comment">// —用户木材</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> soldierNum;<span class="comment">// —用户兵力</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> jungongNum;<span class="comment">// —用户军功数</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> jianghunNum;<span class="comment">// —将魂数量</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> shengwang;<span class="comment">// —声望</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> zxId;<span class="comment">// —阵型id</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> paySum;<span class="comment">// -充值总额</span></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;INT default 0&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> conduction;<span class="comment">// -新手引导</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码中，@Entity和@Table(name = “JunZhu”)就可以使Hibernate在启动时自动创建一个JunZhu表，@Id的属性即设为主键的字段。创建好Model之后，就可以使用Hibernate的session进行数据库操作，这里我将数据库的操作封装为一个工具类HibernateUtil，这个工具类大家可以拿去直接使用，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.hibernate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.sf.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.hibernate.Query;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.SQLQuery;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.Session;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.SessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.annotations.Where;</span><br><span class="line"><span class="keyword">import</span> org.hibernate.transform.Transformers;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.FileSystemXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.card.CardInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.equip.EquipInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.mail.MailInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.pve.PveInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.zhenxing.ZhenXingInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.zhenxing.ZhenxingMgr;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.task.ExecutorPool;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.cache.MC;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.cache.MCSupport;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.memcached.MemcachedCRUD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HibernateUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> showMCHitLog = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(HibernateUtil.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, String&gt; beanKeyMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, String&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> synDelayT = <span class="number">0</span>;<span class="comment">// 延迟同步周期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sessionFactory = buildSessionFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SessionFactory <span class="title">getSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">insert</span><span class="params">(Object o, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.save(o);</span><br><span class="line">            session.getTransaction().commit();</span><br><span class="line">            <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                synMC4Insert(o.getClass().getSimpleName(), o,</span><br><span class="line">                        String.valueOf(id));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;0要insert的数据&#123;&#125;&quot;</span>, o == <span class="keyword">null</span> ? <span class="string">&quot;null&quot;</span> : JSONObject</span><br><span class="line">                    .fromObject(o).toString());</span><br><span class="line">            log.error(<span class="string">&quot;0保存出错&quot;</span>, e);</span><br><span class="line">            session.getTransaction().rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FIXME 不要这样返回异常，没人会关系返回的异常。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">save</span><span class="params">(Object o, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction t = session.beginTransaction();</span><br><span class="line">        <span class="keyword">boolean</span> mcOk = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                MCSupport s = (MCSupport) o;<span class="comment">// 需要对控制了的对象在第一次存库时调用MC.add</span></span><br><span class="line">                MC.update(o, String.valueOf(s.getIdentifier()));<span class="comment">// MC中控制了哪些类存缓存。</span></span><br><span class="line">                mcOk = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// session.update(o);</span></span><br><span class="line">                session.saveOrUpdate(o);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                session.saveOrUpdate(o);</span><br><span class="line">            &#125;</span><br><span class="line">            t.commit();</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                    synMC4Save(o.getClass().getSimpleName(), o,</span><br><span class="line">                            String.valueOf(id));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;1要save的数据&#123;&#125;,&#123;&#125;&quot;</span>, o, o == <span class="keyword">null</span> ? <span class="string">&quot;null&quot;</span> : JSONObject</span><br><span class="line">                    .fromObject(o).toString());</span><br><span class="line">            <span class="keyword">if</span> (mcOk) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;MC保存成功后报错，可能是数据库条目丢失。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.error(<span class="string">&quot;1保存出错&quot;</span>, e);</span><br><span class="line">            t.rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">update</span><span class="params">(Object o, String id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction t = session.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                MCSupport s = (MCSupport) o;<span class="comment">// 需要对控制了的对象在第一次存库时调用MC.add</span></span><br><span class="line">                MC.update(o, String.valueOf(s.getIdentifier()));<span class="comment">// MC中控制了哪些类存缓存。</span></span><br><span class="line">                session.update(o);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                session.update(o);</span><br><span class="line">            &#125;</span><br><span class="line">            t.commit();</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                    synMC4Update(o.getClass().getSimpleName(), o,</span><br><span class="line">                            String.valueOf(id));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;1要update的数据&#123;&#125;,&#123;&#125;&quot;</span>, o, o == <span class="keyword">null</span> ? <span class="string">&quot;null&quot;</span> : JSONObject</span><br><span class="line">                    .fromObject(o).toString());</span><br><span class="line">            log.error(<span class="string">&quot;1保存出错&quot;</span>, e);</span><br><span class="line">            t.rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; t, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        String keyField = getKeyField(t);</span><br><span class="line">        <span class="keyword">if</span> (keyField == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;类型&quot;</span> + t + <span class="string">&quot;没有标注主键&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!MC.cachedClass.contains(t)) &#123;</span><br><span class="line">            <span class="keyword">return</span> find(t, <span class="string">&quot;where &quot;</span> + keyField + <span class="string">&quot;=&quot;</span> + id, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        T ret = MC.get(t, String.valueOf(id));</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">&quot;MC未命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), id);</span><br><span class="line">            ret = find(t, <span class="string">&quot;where &quot;</span> + keyField + <span class="string">&quot;=&quot;</span> + id, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">&quot;DB命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), id);</span><br><span class="line">                MC.add(ret, String.valueOf(id));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">&quot;DB未命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">&quot;MC命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; t, String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> find(t, where, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; t, String where, <span class="keyword">boolean</span> checkMCControl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// if (checkMCControl &amp;&amp; MC.cachedClass.contains(t)) &#123;</span></span><br><span class="line">        <span class="comment">// // 请使用static &lt;T&gt; T find(Class&lt;T&gt; t,long id)</span></span><br><span class="line">        <span class="comment">// throw new BaseException(&quot;由MC控制的类不能直接查询DB:&quot; + t);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        T ret = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// FIXME 使用 session的get方法代替。</span></span><br><span class="line">            String hql = <span class="string">&quot;from &quot;</span> + t.getSimpleName() + <span class="string">&quot; &quot;</span> + where;</span><br><span class="line">            Query query = session.createQuery(hql);</span><br><span class="line">            ret = (T) query.uniqueResult();</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">&quot;list fail for &#123;&#125; &#123;&#125;&quot;</span>, t, where);</span><br><span class="line">            log.error(<span class="string">&quot;list fail&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">list</span><span class="params">(Class&lt;T&gt; t, <span class="keyword">long</span> id, String where)</span> </span>&#123;</span><br><span class="line">        String keyField = getKeyField(t);</span><br><span class="line">        <span class="keyword">if</span> (keyField == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;类型&quot;</span> + t + <span class="string">&quot;没有标注主键&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!MC.cachedList.contains(t.getSimpleName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> list(t, where, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;T&gt; ret = MC.getList(t, String.valueOf(id), where);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">&quot;MC未命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), where);</span><br><span class="line">            ret = list(t, where, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">&quot;DB命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), where);</span><br><span class="line">                MC.addList(ret, t.getSimpleName(), String.valueOf(id), where);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                    log.info(<span class="string">&quot;DB未命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), where);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (showMCHitLog)</span><br><span class="line">                log.info(<span class="string">&quot;MC命中&#123;&#125;#&#123;&#125;&quot;</span>, t.getSimpleName(), where);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> where</span></span><br><span class="line"><span class="comment">     *            例子： where uid&gt;100</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">list</span><span class="params">(Class&lt;T&gt; t, String where,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> checkMCControl)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// if (checkMCControl &amp;&amp; MC.cachedList.contains(t)) &#123;</span></span><br><span class="line">        <span class="comment">// // 请使用static &lt;T&gt; T find(Class&lt;T&gt; t,long id)</span></span><br><span class="line">        <span class="comment">// throw new BaseException(&quot;由MC控制的类不能直接查询DB:&quot; + t);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        List&lt;T&gt; list = Collections.EMPTY_LIST;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String hql = <span class="string">&quot;from &quot;</span> + t.getSimpleName() + <span class="string">&quot; &quot;</span> + where;</span><br><span class="line">            Query query = session.createQuery(hql);</span><br><span class="line">            list = query.list();</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">&quot;list fail for &#123;&#125; &#123;&#125;&quot;</span>, t, where);</span><br><span class="line">            log.error(<span class="string">&quot;list fail&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SessionFactory <span class="title">buildSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始构建hibernate&quot;</span>);</span><br><span class="line">        String path = <span class="string">&quot;classpath*:spring-conf/applicationContext.xml&quot;</span>;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> FileSystemXmlApplicationContext(path);</span><br><span class="line">        sessionFactory = (SessionFactory) ac.getBean(<span class="string">&quot;sessionFactory&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;结束构建hibernate&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Throwable <span class="title">delete</span><span class="params">(Object o, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.delete(o);</span><br><span class="line">            session.getTransaction().commit();</span><br><span class="line">            <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MCSupport) &#123;</span><br><span class="line">                MCSupport s = (MCSupport) o;<span class="comment">// 需要对控制了的对象在第一次存库时调用MC.add</span></span><br><span class="line">                MC.delete(o.getClass(), String.valueOf(s.getIdentifier()));<span class="comment">// MC中控制了哪些类存缓存。</span></span><br><span class="line">                <span class="keyword">if</span> (MC.cachedList.contains(o.getClass().getSimpleName())) &#123;</span><br><span class="line">                    synMC4Delete(o.getClass().getSimpleName(), o,</span><br><span class="line">                            String.valueOf(id));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;要删除的数据&#123;&#125;&quot;</span>, o);</span><br><span class="line">            log.error(<span class="string">&quot;出错&quot;</span>, e);</span><br><span class="line">            session.getTransaction().rollback();</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注意这个方法会返回大于等于1的值。数据库无记录也会返回1，而不是null</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Long <span class="title">getTableIDMax</span><span class="params">(Class&lt;T&gt; t)</span> </span>&#123;</span><br><span class="line">        Long id = <span class="keyword">null</span>;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        String hql = <span class="string">&quot;select max(id) from &quot;</span> + t.getSimpleName();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Query query = session.createQuery(hql);</span><br><span class="line">            Object uniqueResult = query.uniqueResult();</span><br><span class="line">            <span class="keyword">if</span> (uniqueResult == <span class="keyword">null</span>) &#123;</span><br><span class="line">                id = <span class="number">1L</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                id = Long.parseLong(uniqueResult + <span class="string">&quot;&quot;</span>);</span><br><span class="line">                id = Math.max(<span class="number">1L</span>, id);</span><br><span class="line">            &#125;</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">&quot;query max id fail for &#123;&#125; &#123;&#125;&quot;</span>, t, hql);</span><br><span class="line">            log.error(<span class="string">&quot;query max id fail&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; querySql(String hql) &#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        Transaction tr = session.beginTransaction();</span><br><span class="line">        List list = Collections.emptyList();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SQLQuery query = session.createSQLQuery(hql);</span><br><span class="line">            query.setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP);</span><br><span class="line">            list = query.list();</span><br><span class="line">            tr.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            tr.rollback();</span><br><span class="line">            log.error(<span class="string">&quot;query  failed &#123;&#125;&quot;</span>, hql);</span><br><span class="line">            log.error(<span class="string">&quot;query count(type) fail&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码中，除了调用session的数据库操作API之外，我还使用了Memcache进行结果集的缓存，具体关系Memcache和Mysql的集合使用，在下文中在进行讲解。上文代码中首先在服务器启动时，需要构建SessionFactory，然后通过操作session开始事务，通过session调用CRUD方法进行操作，之后再调用commit方法提交并结束事务，中间如果发生异常则进行rollback操作回滚事务。</p>
<h2 id="Redis存储数据"><a href="#Redis存储数据" class="headerlink" title="Redis存储数据"></a>Redis存储数据</h2><p>游戏中的热数据的存储我选用了Redis，Redis不仅是运行在内存上的内存数据库，并且它的数据存储结构也是很丰富的，包括String，Set，List，Sorted Set和Hash五种数据结构，我对游戏数据的热数据进行了分析，如下图：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/Redis%E6%95%B0%E6%8D%AE.png" alt="Redis数据"><br>使用Redis首先得了解Redis的五种基本数据类型，每一种数据类型都对应不同的Redis操作API，在Java中使用Redis可以使用官方提供的Jedis客户端，Jedis客户端中包含了各种数据类型的操作，我将所有的Redis操作都封装在了Redis类中，启动时调用init方法进行Redis连接，使用时通过getInstance获取实例，再调用相应的API即可完成相关的Redis操作，在init方法中，我是通过调用JedisSentinelPool去获取Redis的连接，因为我在服务器对Redis做了Sentinel的集群部署，大家可以直接拿这个Redis工具类去使用，Redis类的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.redis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.beans.BeanInfo;</span><br><span class="line"><span class="keyword">import</span> java.beans.IntrospectionException;</span><br><span class="line"><span class="keyword">import</span> java.beans.Introspector;</span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.HostAndPort;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisSentinelPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Tuple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Redis</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Redis instance;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Redis.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> GLOBAL_DB = <span class="number">0</span>;<span class="comment">// 全局</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOGIC_DB = GameInit.serverId;<span class="comment">// 模块库</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String password = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Redis <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Redis();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private JedisPool pool;</span></span><br><span class="line">    <span class="keyword">private</span> JedisSentinelPool sentinelPool;</span><br><span class="line">    <span class="keyword">public</span> String host;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// public int getDB(long userid)&#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Jedis <span class="title">getJedis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sentinelPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnResource</span><span class="params">(Jedis jedis)</span> </span>&#123;</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="comment">// this.sentinelPool.returnResource(jedis);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String redisServer = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (GameInit.cfg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            redisServer = GameInit.cfg.get(<span class="string">&quot;redisServer&quot;</span>);</span><br><span class="line">            password = GameInit.cfg.get(<span class="string">&quot;redisPwd&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisServer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            redisServer = <span class="string">&quot;127.0.0.1:6440&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        redisServer = redisServer.trim();</span><br><span class="line">        String[] tmp = redisServer.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        host = tmp[<span class="number">0</span>];</span><br><span class="line">        port = Integer.parseInt(tmp[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (tmp.length == <span class="number">2</span>) &#123;</span><br><span class="line">            port = Integer.parseInt(tmp[<span class="number">1</span>].trim());</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;Redis sentinel at &#123;&#125;:&#123;&#125;&quot;</span>, host, port);</span><br><span class="line">        <span class="comment">// sentinelPool = new JedisPool(host, port);</span></span><br><span class="line">        Set sentinels = <span class="keyword">new</span> HashSet();</span><br><span class="line">        sentinels.add(<span class="keyword">new</span> HostAndPort(host, port).toString());</span><br><span class="line">        sentinelPool = <span class="keyword">new</span> JedisSentinelPool(<span class="string">&quot;master1&quot;</span>, sentinels);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private void init() &#123;</span></span><br><span class="line">    <span class="comment">// String redisServer = null;</span></span><br><span class="line">    <span class="comment">// if (GameInit.cfg != null) &#123;</span></span><br><span class="line">    <span class="comment">// redisServer = GameInit.cfg.get(&quot;redisServer&quot;);</span></span><br><span class="line">    <span class="comment">// password = GameInit.cfg.get(&quot;redisPwd&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// if (redisServer == null) &#123;</span></span><br><span class="line">    <span class="comment">// redisServer = &quot;127.0.0.1:6379&quot;;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// redisServer = redisServer.trim();</span></span><br><span class="line">    <span class="comment">// String[] tmp = redisServer.split(&quot;:&quot;);</span></span><br><span class="line">    <span class="comment">// host = tmp[0];</span></span><br><span class="line">    <span class="comment">// port = Integer.parseInt(tmp[1]);</span></span><br><span class="line">    <span class="comment">// if (tmp.length == 2) &#123;</span></span><br><span class="line">    <span class="comment">// port = Integer.parseInt(tmp[1].trim());</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// log.info(&quot;Redis at &#123;&#125;:&#123;&#125;&quot;, host, port);</span></span><br><span class="line">    <span class="comment">// // sentinelPool = new JedisPool(host, port);</span></span><br><span class="line">    <span class="comment">// JedisPoolConfig config = new JedisPoolConfig();</span></span><br><span class="line">    <span class="comment">// sentinelPool = new JedisPool(config, host, port, 100000, password);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Jedis j = getJedis();</span><br><span class="line">        j.auth(password);</span><br><span class="line">        returnResource(j);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        Jedis j = getJedis();</span><br><span class="line">        j.auth(password);</span><br><span class="line">        j.select(index);</span><br><span class="line">        returnResource(j);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hexist</span><span class="params">(<span class="keyword">int</span> db, String key, String field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        <span class="keyword">boolean</span> ret = redis.hexists(key, field);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">hdel</span><span class="params">(<span class="keyword">int</span> db, String key, String... fields)</span> </span>&#123;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        Long cnt = redis.hdel(key, fields);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hget</span><span class="params">(<span class="keyword">int</span> db, String key, String field)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        String ret = redis.hget(key, field);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">hgetAll</span><span class="params">(<span class="keyword">int</span> db, String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        Map&lt;String, String&gt; ret = redis.hgetAll(key);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hset</span><span class="params">(<span class="keyword">int</span> db, String key, String field, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (field == <span class="keyword">null</span> || field.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        redis.hset(key, field, value);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> db, String group, String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        redis.hset(group, key, value);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> db, String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        redis.set(key, value);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">int</span> db, String key)</span> </span>&#123;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        String ret = redis.get(key);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加元素到集合中</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> element</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sadd</span><span class="params">(<span class="keyword">int</span> db, String key, String... element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (element == <span class="keyword">null</span> || element.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        <span class="keyword">boolean</span> success = redis.sadd(key, element) == <span class="number">1</span>;</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">smove</span><span class="params">(<span class="keyword">int</span> db, String oldKey, String newKey, String element)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (element == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis redis = getJedis();</span><br><span class="line">        redis.auth(password);</span><br><span class="line">        redis.select(db);</span><br><span class="line">        <span class="keyword">boolean</span> success = (redis.smove(oldKey, newKey, element) == <span class="number">1</span>);</span><br><span class="line">        returnResource(redis);</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getInstance().sentinelPool.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中间省略一万字：中间都是Redis的各种API的操作，需要了解的朋友可以去看看Jedis的API文档</span></span><br></pre></td></tr></table></figure>
<h2 id="Memcache数据结果集缓存"><a href="#Memcache数据结果集缓存" class="headerlink" title="Memcache数据结果集缓存"></a>Memcache数据结果集缓存</h2><p>上文在介绍Hibernate中说到了Memcache对Mysql结果集的缓存，Memcache作为一种内存数据库，经常用作应用系统的缓存系统，我也将Memcache引入到项目作为Mysql数据结果集的缓存系统，其实在实现Memcache对Mysql查询的缓存的过程中，我曾进行了多种尝试，具体有以下几种缓存模型：<br>1.无缓存<br>这种方式不使用Memcache缓存，游戏服务器的操作直接穿透到Mysql中，这种方式在高并发环境下容易引起Mysql服务器高负载情况，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B1.png" alt="缓存模型1"><br>2.查询使用缓存，更新穿透到数据库，数据库同步数据到缓存<br>这种方式在客户端表现来看可以提供一部分速度，因为查询操作都是基于缓存的，但实际上Mysql的负担反而加大了，因为每一个更新请求，都需要Mysql同步最新的查询结果集给Memcache，因为每一个更新操作都会带来一个查询操作，当然这个同步过程可以使异步，但是就算我们感受不到这个同步的过程，但在实际上也是加大了数据库的负载，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B2.png" alt="缓存模型2"><br>3.更新和查询都使用缓存，缓存按策略与数据库进行同步<br>这种方式是比较好的方式，因为客户端的所有操作都是被缓存给拦截下来了，所有操作均是基于缓存，不会穿透到数据库，而缓存与数据库之间可以按照一定策略进行同步，如每5分钟同步一次数据到数据库等，具体同步策略可根据情况具体调整，当然这种方式的缺陷就是一旦服务器宕机，那么在上次同步到宕机这段时间之间的数据都会丢失，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B3.png" alt="缓存模型3"><br>4.更新和查询都是用缓存，更新操作同时穿透到数据库，数据库同步缓存的查询<br>这种方式是我最终使用的方式，虽然更新操作穿透到数据库，但是我可以在保证查询效率的同时，也保证数据的安全稳定性，因为每一步更新操作都是要进行数据库存储的，并且所有的查询操作可以直接在缓存中进行，如下图所示：<br><img src="http://7xnnwn.com1.z0.glb.clouddn.com/%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B4.png" alt="缓存模型4"></p>
<p>需要支持缓存的类需实现MCSupport接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现此接口后还需要再MC类中增加cachedClass，并使用</span></span><br><span class="line"><span class="comment"> * com.qx.persistent.HibernateUtil.find(Class&lt;T&gt;, long)</span></span><br><span class="line"><span class="comment"> * 代替where进行查询。</span></span><br><span class="line"><span class="comment"> * 需要对控制了的对象在第一次存库时调用MC.add，再调用HIbernateUtil.insert</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 何金成</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MCSupport</span> <span class="keyword">extends</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getIdentifier</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Memcache的工具类MemcacheCRUD实现了Memcache的连接，以及add，update，delete等操作，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.memcached;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.danga.MemCached.MemCachedClient;</span><br><span class="line"><span class="keyword">import</span> com.danga.MemCached.SockIOPool;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 何金成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemcachedCRUD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Logger logger = LoggerFactory</span><br><span class="line">            .getLogger(MemcachedCRUD.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String poolName = <span class="string">&quot;gameDBPool&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> MemCachedClient memCachedClient;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> MemcachedCRUD memcachedCRUD = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SockIOPool sockIoPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MemcachedCRUD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sockIoPool = init(poolName, <span class="string">&quot;cacheServer&quot;</span>);</span><br><span class="line">        memCachedClient = <span class="keyword">new</span> MemCachedClient(poolName);</span><br><span class="line">        <span class="comment">// if true, then store all primitives as their string value.</span></span><br><span class="line">        memCachedClient.setPrimitiveAsString(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SockIOPool <span class="title">init</span><span class="params">(String poolName, String confKey)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 缓存服务器</span></span><br><span class="line">        String cacheServers = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (GameInit.cfg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cacheServers = GameInit.cfg.getServerByName(confKey);</span><br><span class="line">        &#125;</span><br><span class="line">        String server[] = &#123; <span class="string">&quot;127.0.0.1:11211&quot;</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (cacheServers == <span class="keyword">null</span> || <span class="string">&quot;&quot;</span>.equals(cacheServers)) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            server[<span class="number">0</span>] = cacheServers;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个连接池</span></span><br><span class="line">        SockIOPool pool = SockIOPool.getInstance(poolName);</span><br><span class="line">        logger.info(<span class="string">&quot;连接池&#123;&#125;缓存配置 &#123;&#125;&quot;</span>, poolName, Arrays.toString(server));</span><br><span class="line">        pool.setServers(server);<span class="comment">// 缓存服务器</span></span><br><span class="line">        pool.setInitConn(<span class="number">50</span>); <span class="comment">// 初始化链接数</span></span><br><span class="line">        pool.setMinConn(<span class="number">50</span>); <span class="comment">// 最小链接数</span></span><br><span class="line">        pool.setMaxConn(<span class="number">500</span>); <span class="comment">// 最大连接数</span></span><br><span class="line">        pool.setMaxIdle(<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>);<span class="comment">// 最大处理时间</span></span><br><span class="line">        pool.setMaintSleep(<span class="number">3000</span>);<span class="comment">// 设置主线程睡眠时,每3秒苏醒一次，维持连接池大小</span></span><br><span class="line">        pool.setNagle(<span class="keyword">false</span>);<span class="comment">// 关闭套接字缓存</span></span><br><span class="line">        pool.setSocketTO(<span class="number">3000</span>);<span class="comment">// 链接建立后超时时间</span></span><br><span class="line">        pool.setSocketConnectTO(<span class="number">0</span>);<span class="comment">// 链接建立时的超时时间</span></span><br><span class="line">        pool.initialize();</span><br><span class="line">        <span class="keyword">return</span> pool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sockIoPool.shutDown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemcachedCRUD <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (memcachedCRUD == <span class="keyword">null</span>) &#123;</span><br><span class="line">            memcachedCRUD = <span class="keyword">new</span> MemcachedCRUD();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> memcachedCRUD;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> INTERVAL = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exist</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.keyExists(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(String key, Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.add(key, o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(String key, Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.replace(key, o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">saveObject</span><span class="params">(String key, Object msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> o = memCachedClient.keyExists(key);</span><br><span class="line">        <span class="keyword">if</span> (o) &#123;<span class="comment">// 存在替换掉</span></span><br><span class="line">            <span class="keyword">return</span> memCachedClient.replace(key, msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> memCachedClient.add(key, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">keyExist</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.keyExists(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * delete</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteObject</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Object obj = memCachedClient.get(key);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MemCachedClient <span class="title">getMemCachedClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memCachedClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Memcache进行缓存，则需要封装一个缓存的操作工具类MC，封装各种缓存操作方法，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kidbear._36.util.cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.core.GameInit;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.bag.ItemInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.building.BuildingInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.card.CardInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.equip.EquipInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.junzhu.JunZhu;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.mail.MailInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.pve.PveInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.task.MainTaskInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.tec.TecInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.manager.zhenxing.ZhenXingInfo;</span><br><span class="line"><span class="keyword">import</span> com.kidbear._36.util.memcached.MemcachedCRUD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MC</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制哪些类进行memcached缓存。 被控制的类在进行创建时，需要注意调用MC的add和hibernate的insert。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;? extends MCSupport&gt;&gt; cachedClass = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends MCSupport&gt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; cachedList = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        cachedClass.add(JunZhu.class);</span><br><span class="line">        <span class="comment">// 添加需要缓存find操作的类</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        cachedList.add(CardInfo.class.getSimpleName());</span><br><span class="line">        <span class="comment">// 添加需要缓存list操作的类</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(Class&lt;T&gt; t, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(t)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>).append(t.getSimpleName())</span><br><span class="line">                .append(<span class="string">&quot;#&quot;</span>).append(id);</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key.toString());</span><br><span class="line">        <span class="keyword">return</span> (T) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getList</span><span class="params">(Class&lt;T&gt; t, String id, String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(t.getSimpleName())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>).append(id).append(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">                .append(t.getSimpleName()).append(<span class="string">&quot;#&quot;</span>).append(where);</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key.toString());</span><br><span class="line">        <span class="keyword">return</span> (List&lt;T&gt;) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">String <span class="title">getListKeys</span><span class="params">(String tName, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(tName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>).append(id).append(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">                .append(tName);</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key.toString());</span><br><span class="line">        <span class="keyword">return</span> (String) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getValue</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Object o = MemcachedCRUD.getInstance().getObject(key);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Object t, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(t.getClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">                .append(t.getClass().getSimpleName()).append(<span class="string">&quot;#&quot;</span>).append(id);</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().add(key.toString(), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addList</span><span class="params">(List list, String tName, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(tName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>).append(id).append(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">                .append(tName);</span><br><span class="line">        String c = key.toString();</span><br><span class="line">        key.append(<span class="string">&quot;#&quot;</span>).append(where);</span><br><span class="line">        Object tmp = MemcachedCRUD.getInstance().getObject(c);</span><br><span class="line">        String keys = tmp == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : (String) tmp;</span><br><span class="line">        <span class="keyword">if</span> (keys.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().add(c, key.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!keys.contains(key.toString())) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().update(c, keys + <span class="string">&quot;,&quot;</span> + key.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().add(key.toString(), list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addKeyValue</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().add(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Object t, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(t.getClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">                .append(t.getClass().getSimpleName()).append(<span class="string">&quot;#&quot;</span>).append(id);</span><br><span class="line">        MemcachedCRUD.getInstance().update(key.toString(), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">updateList</span><span class="params">(List list, String tName, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            String where)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedList.contains(tName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>).append(id).append(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">                .append(tName);</span><br><span class="line">        String c = key.toString();</span><br><span class="line">        key.append(<span class="string">&quot;#&quot;</span>).append(where);</span><br><span class="line">        Object tmp = MemcachedCRUD.getInstance().getObject(c);</span><br><span class="line">        String keys = tmp == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : (String) tmp;</span><br><span class="line">        <span class="keyword">if</span> (keys.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().add(c, key.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!keys.contains(key)) &#123;</span><br><span class="line">            MemcachedCRUD.getInstance().update(c, keys + <span class="string">&quot;,&quot;</span> + key.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MemcachedCRUD.getInstance().update(key.toString(), list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主键删除缓存</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     *            删除对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     *            主键id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Class clazz, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!cachedClass.contains(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuffer key = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        key.append(GameInit.serverId).append(<span class="string">&quot;#&quot;</span>).append(clazz.getSimpleName())</span><br><span class="line">                .append(<span class="string">&quot;#&quot;</span>).append(id);</span><br><span class="line">        MemcachedCRUD.getInstance().deleteObject(key.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码中，find方法的缓存和list方法的缓存需要分别实现，find方法缓存只需要将类名和id作为key，对象作为value即可，而list的缓存不仅需要缓存所有的结果集，还需要缓存所有的where查询条件，根据类型查询出where条件，然后根据where条件分别进行缓存。<br>HibernateUtil中使用缓存部分的java代码如下，其中注释的方法为上面第二种缓存模型的实现（现已被我淘汰）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Insert</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">&quot;#&quot;</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            list.add(o);</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Save</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">&quot;#&quot;</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            MCSupport mc = (MCSupport) o;</span><br><span class="line">            <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Iterator iterator = list.iterator(); iterator.hasNext(); index++) &#123;</span><br><span class="line">                MCSupport tmpObj = (MCSupport) iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (tmpObj.getIdentifier() == mc.getIdentifier()) &#123;</span><br><span class="line">                    list.set(index, o);</span><br><span class="line">                    flag = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                list.add(o);</span><br><span class="line">            &#125;</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Update</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">&quot;#&quot;</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            MCSupport mc = (MCSupport) o;</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (Iterator iterator = list.iterator(); iterator.hasNext(); index++) &#123;</span><br><span class="line">                MCSupport tmpObj = (MCSupport) iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (tmpObj.getIdentifier() == mc.getIdentifier()) &#123;</span><br><span class="line">                    list.set(index, o);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">synMC4Delete</span><span class="params">(String tName, Object o, String id)</span> </span>&#123;</span><br><span class="line">    String keys = MC.getListKeys(tName, id);</span><br><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;<span class="comment">// 遍历所有的where缓存</span></span><br><span class="line">        String[] wheres = keys.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String where : wheres) &#123;</span><br><span class="line">            where = where.split(<span class="string">&quot;#&quot;</span>)[<span class="number">3</span>];</span><br><span class="line">            List list = MC.getList(o.getClass(), id, where);</span><br><span class="line">            MCSupport mc = (MCSupport) o;</span><br><span class="line">            <span class="keyword">for</span> (Iterator iterator = list.iterator(); iterator.hasNext();) &#123;</span><br><span class="line">                MCSupport tmpObj = (MCSupport) iterator.next();</span><br><span class="line">                <span class="keyword">if</span> (tmpObj.getIdentifier() == mc.getIdentifier()) &#123;</span><br><span class="line">                    iterator.remove();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MC.updateList(list, tName, id, where);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// public static &lt;T&gt; void synchronizeDB2MemAsy(final Class&lt;T&gt; t,</span></span><br><span class="line"><span class="comment">// final String id) &#123;</span></span><br><span class="line"><span class="comment">// ExecutorPool.dbThread.execute(new Runnable() &#123;</span></span><br><span class="line"><span class="comment">// @Override</span></span><br><span class="line"><span class="comment">// public void run() &#123;</span></span><br><span class="line"><span class="comment">// String keys = MC.getListKeys(t.getSimpleName(), id);</span></span><br><span class="line"><span class="comment">// if (keys != null &amp;&amp; keys.length() &gt; 0) &#123;// 遍历所有的where缓存</span></span><br><span class="line"><span class="comment">// String[] wheres = keys.split(&quot;,&quot;);</span></span><br><span class="line"><span class="comment">// for (String where : wheres) &#123;</span></span><br><span class="line"><span class="comment">// where = where.split(&quot;#&quot;)[3];</span></span><br><span class="line"><span class="comment">// List&lt;T&gt; list = list(t, where, false);</span></span><br><span class="line"><span class="comment">// MC.updateList(list, t.getSimpleName(), id, where);</span></span><br><span class="line"><span class="comment">// if (showMCHitLog) &#123;</span></span><br><span class="line"><span class="comment">// log.info(&quot;DB 同步 MC 成功 t:&#123;&#125;,where:&#123;&#125;&quot;,</span></span><br><span class="line"><span class="comment">// t.getSimpleName(), where);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// public static &lt;T&gt; void synchronizeDB2MemSyn(final Class&lt;T&gt; t,</span></span><br><span class="line"><span class="comment">// final String id) &#123;</span></span><br><span class="line"><span class="comment">// String keys = MC.getListKeys(t.getSimpleName(), id);</span></span><br><span class="line"><span class="comment">// if (keys != null &amp;&amp; keys.length() &gt; 0) &#123;// 遍历所有的where缓存</span></span><br><span class="line"><span class="comment">// String[] wheres = keys.split(&quot;,&quot;);</span></span><br><span class="line"><span class="comment">// for (String where : wheres) &#123;</span></span><br><span class="line"><span class="comment">// where = where.split(&quot;#&quot;)[3];</span></span><br><span class="line"><span class="comment">// List&lt;T&gt; list = list(t, where, false);</span></span><br><span class="line"><span class="comment">// MC.updateList(list, t.getSimpleName(), id, where);</span></span><br><span class="line"><span class="comment">// if (showMCHitLog) &#123;</span></span><br><span class="line"><span class="comment">// log.info(&quot;DB 同步 MC 成功 t:&#123;&#125;,where:&#123;&#125;&quot;, t.getSimpleName(),</span></span><br><span class="line"><span class="comment">// where);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上是本文对我们这款游戏中的数据管理的介绍，游戏服务器中的各种数据是多种多样的，我们应该根据各种数据的各种性质，合理利用进行存取，以保证不管什么类型的游戏数据，在我们的游戏服务器中都可以安全稳定的运行，数据安全，玩家才会放心！</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>Donate comment here.</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="https://www.hjcenry.com/res/img/wechat_pay.jpg" alt="Henry He 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="https://www.hjcenry.com/res/img/alipay.jpg" alt="Henry He 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://www.hjcenry.com/res/img/wx.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/%E6%B8%B8%E6%88%8F%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"># 游戏服务器</a>
              <a href="/tags/SLG/" rel="tag"># SLG</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2016/08/27/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/" rel="prev" title="SLG手游Java服务器的设计与开发——网络通信">
      <i class="fa fa-chevron-left"></i> SLG手游Java服务器的设计与开发——网络通信
    </a></div>
      <div class="post-nav-item">
    <a href="/2016/10/22/SLG%E6%89%8B%E6%B8%B8Java%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E6%96%B9%E6%A1%88/" rel="next" title="SLG手游Java服务器数据管理方案">
      SLG手游Java服务器数据管理方案 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="SOHUCS" sid=""></div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B8%E6%88%8F%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">游戏数据分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B8%E6%88%8F%E9%9D%99%E6%80%81%E6%95%B0%E6%8D%AE"><span class="nav-number">3.</span> <span class="nav-text">游戏静态数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dataConfig-xml"><span class="nav-number">3.1.</span> <span class="nav-text">dataConfig.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSV%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">CSV文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JavaBean"><span class="nav-number">3.3.</span> <span class="nav-text">JavaBean</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CsvDataLoader-java"><span class="nav-number">3.4.</span> <span class="nav-text">CsvDataLoader.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CsvParser"><span class="nav-number">3.5.</span> <span class="nav-text">CsvParser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TempletService-java"><span class="nav-number">3.6.</span> <span class="nav-text">TempletService.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E9%9D%99%E6%80%81%E6%95%B0%E6%8D%AE"><span class="nav-number">3.7.</span> <span class="nav-text">使用静态数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE"><span class="nav-number">4.</span> <span class="nav-text">Mysql存储数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Druid%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="nav-number">4.1.</span> <span class="nav-text">Druid数据库连接池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hibernate"><span class="nav-number">4.2.</span> <span class="nav-text">Hibernate</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE"><span class="nav-number">5.</span> <span class="nav-text">Redis存储数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memcache%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%9C%E9%9B%86%E7%BC%93%E5%AD%98"><span class="nav-number">6.</span> <span class="nav-text">Memcache数据结果集缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Henry He"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Henry He</p>
  <div class="site-description" itemprop="description">我们不生产代码，我们只是API的搬运工</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element">
    <a onclick="tidioChatApi.open();"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hjcenry" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hjcenry" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/channel/UC9EM174qUGvIm8uQHILXE3Q" title="YouTube → https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UC9EM174qUGvIm8uQHILXE3Q" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hejincheng1209@163.com" title="E-Mail → mailto:hejincheng1209@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/15286724" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;15286724" rel="noopener" target="_blank"><i class="fab fa-bilibili fa-fw"></i>Bilibili</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/2996874513/profile?topnav=1&wvr=6&is_all=1" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;2996874513&#x2F;profile?topnav&#x3D;1&amp;wvr&#x3D;6&amp;is_all&#x3D;1" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://me.csdn.net/weixin_43495590" title="https:&#x2F;&#x2F;me.csdn.net&#x2F;weixin_43495590" rel="noopener" target="_blank">周piaopiao</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.baitanwa.com/" title="https:&#x2F;&#x2F;www.baitanwa.com" rel="noopener" target="_blank">泽北大佬</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2020034953号 </a>
      <img src="https://www.hjcenry.com/res/img/beianicon.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502042351" rel="noopener" target="_blank">11010502042351 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Henry He</span>


  <div style="float:right;display:inline-block;">
    <p style="float:left;height:20px;line-height:20px;margin: 0px 20px 0px 5px; color:#939393;">京ICP备2020034953号</p>
    <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502042351" style="float:right;display:inline-block;text-decoration:none;height:20px;line-height:20px;">
      <img src="https://www.hjcenry.com/res/img/beianicon.png" style="float:left;">
      <p style="float:right;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">京公网安备 11010502042351号</p>
    </a>
  </div>

  <!-- 网站域名公安备案 -->
  <!--
  <div style="width:600px;margin:0 auto; padding:20px 0;">
      <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502042351" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;">
      <img src="https://www.hjcenry.com/res/img/beianicon.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">京公网安备 11010502042351号</p></a><p style="float:right;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">京ICP备2020034953号</p>
  </div>
  -->
</div>

<!--
-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"DQrsykJ4iGseNRFW3YLghDqk-gzGzoHsz","app_key":"77GsyoUfVcOoIueBsMYv2PoP","server_url":null,"security":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>

      <script src="/js/live2d/autoload.js"></script>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>






  <script src="//code.tidio.co/6vdofc43qnpkj50mghb80jws0rjhfjwb.js"></script>







  

  

  <script>
  NexT.utils.loadComments(document.querySelector('#SOHUCS'), () => {
    var appid = 'cyv4Jfx7D';
    var conf = '09034f3bb4af424e1d479cd8cfc7de8a';
    var width = window.innerWidth || document.documentElement.clientWidth;
    if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>');
    } else {
      var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})});
    }
  });
  </script>
  <script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>

</body>
</html>
